name: 生成每日分析报告

on:
  push:
    branches:
      - main
  schedule:
    # 每个交易日下午4点执行(北京时间16:00 = UTC 08:00)
    - cron: '0 8 * * 1-5'
  workflow_dispatch: # 允许手动触发
    inputs:
      report_date:
        description: '报告日期 (YYYYMMDD, 留空则为当天)'
        required: false
        default: ''

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: 安装依赖
      run: |
        uv sync
        
    - name: 生成当日报告
      run: |
        # 优先使用输入的日期
        DATE="${{ inputs.report_date }}"
        # 如果输入为空,则使用当前日期
        if [ -z "$DATE" ]; then
          DATE=$(date +%Y%m%d)
        fi
        echo "生成日期: $DATE"
        uv run python fupan.py --date $DATE || echo "报告生成失败,但继续执行"
      continue-on-error: true
        
    - name: 提交报告
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add reports/ data/ || true
        git commit -m "自动生成报告 $(date +%Y%m%d)" || echo "没有变更"
        git push || echo "推送失败"
      continue-on-error: true
        
    - name: 准备GitHub Pages内容
      if: always()
      run: |
        # 确保reports目录存在
        mkdir -p reports
        # 复制Web界面到reports目录
        cp web/index.html reports/index.html
        # 创建reports.json
        cd reports
        # 使用bash生成JSON
        echo -n '{"reports":[' > reports.json
        ls -1 *.md 2>/dev/null | sort -r | sed 's/.*/"&"/' | paste -sd, >> reports.json || true
        echo ']}' >> reports.json
        # 显示内容
        echo "=== reports.json content ==="
        cat reports.json
        echo "=== Directory listing ==="
        ls -la
    - name: 部署到GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./reports
        publish_branch: gh-pages
        enable_jekyll: false
        force_orphan: true
