name: 生成每日分析报告

on:
  push:
    branches:
      - main
  schedule:
    # 每个交易日下午4点执行(北京时间16:00 = UTC 08:00)
    - cron: '0 8 * * 1-5'
  workflow_dispatch:
    inputs:
      report_date:
        description: '报告日期 (YYYYMMDD, 留空则为当天)'
        required: false
        default: ''

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 设置Python环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 安装uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: 安装依赖
        run: |
          uv sync

      # ✅ 新增：先获取市场数据（更可靠）
      - name: 获取市场情绪数据
        run: |
          DATE="${{ inputs.report_date }}"
          if [ -z "$DATE" ]; then
            DATE=$(date +%Y%m%d)
          fi
          echo "获取市场数据: $DATE"
          uv run python fetch_market.py --date $DATE || echo "数据获取失败,尝试继续"
          if [ -f "data/cache_market/市场情绪_${DATE}.csv" ]; then
            echo "✅ 单日数据文件已生成"
            cat "data/cache_market/市场情绪_${DATE}.csv"
          fi
          if [ -f "data/cache_market/市场情绪.csv" ]; then
            echo "✅ 汇总数据文件已更新"
            tail -n 5 data/cache_market/市场情绪.csv
          fi
        continue-on-error: true

      - name: 生成当日报告
        run: |
          DATE="${{ inputs.report_date }}"
          if [ -z "$DATE" ]; then
            DATE=$(date +%Y%m%d)
          fi
          echo "生成报告: $DATE"
          uv run python fupan.py --date $DATE || echo "报告生成失败,但继续执行"
        continue-on-error: true

      - name: 提交报告
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add reports/ data/ || true
          git commit -m "自动生成报告 $(date +%Y%m%d)" || echo "没有变更"
          git push || echo "推送失败"
        continue-on-error: true

      - name: 准备GitHub Pages内容
        if: always()
        run: |
          mkdir -p deploy/reports deploy/data/cache_market
          cp -r reports/*.md deploy/reports/ 2>/dev/null || true
          cp data/cache_market/市场情绪.csv deploy/data/cache_market/ 2>/dev/null || true
          cp web/index.html deploy/index.html
          
          # 生成 reports.json 放在 deploy 根目录
          cd deploy
          echo -n '{"reports":[' > reports.json
          ls -1 reports/*.md 2>/dev/null | sort -r | sed 's/.*/"&"/' | paste -sd, >> reports.json || true
          echo ']}' >> reports.json
          
          echo "=== 部署内容 ==="
          find . -type f

      - name: 部署到GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          publish_branch: gh-pages
          enable_jekyll: false
          force_orphan: true
